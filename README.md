# Line Tools

The repository contains two main parts:
1. ROS packages for detecting lines and clustering in rgb-d image.
2. Python scripts for processing lines data and training on the data to get embeddings for detected lines.

The main functionalities for detecting and clustering lines are with the two directories `line_detection `and `line_clustering`. They can serve as two libraries. These two libraries implemented do only depend on the standard library, OpenCV and glog. In the mean time, they can also serve as ROS packages. There are some ros nodes(for testing purpose) within the `line_detection` package that depend on ROS.

All other ROS dependencies are implemented within a third library in the package `line_ros_utility`. This includes conversion for different datasets, data input/output, communication with python nodes, displaying in rviz.

## Build instructions for ROS packages
You may need to install `python_catkin_tools` and `autoconf`:
```
$ sudo apt-get install python-catkin-tools
$ sudo apt-get install autoconf
```
Creat a catkin workspace:
```
$ mkdir -p ~/catkin_ws/src
$ cd ~/catkin_ws
$ catkin init
```

`git clone` the following packages to your `src` directory in catkin workspace `catkin_ws`

* [catkin_simple](https://github.com/catkin/catkin_simple)
* [eigen_catkin](https://github.com/ethz-asl/eigen_catkin)
* [eigen_checks](https://github.com/ethz-asl/eigen_checks)
* [gflags_catkin](https://github.com/ethz-asl/gflags_catkin)
* [glog_catkin](https://github.com/ethz-asl/glog_catkin/)
* [line_tools](https://github.com/ethz-asl/line_tools/)
* [opencv3_catkin](https://github.com/ethz-asl/opencv3_catkin/)
* [pcl_catkin](https://github.com/ethz-asl/pcl_catkin/)
* [scenenet_ros_tools](https://github.com/ethz-asl/scenenet_ros_tools/)
* [vision_opencv](https://github.com/ethz-asl/vision_opencv)

You also need to edit the file `CMakeLists.txt` in the `opencv3_catkin` directory by:
- modifying the following three lines:
```
-DBUILD_opencv_python3=ON
...
-DBUILD_opencv_line_descriptor=ON
...
-DBUILD_opencv_ximgproc=ON
```
- adding the following line:
```
-DBUILD_opencv_nonfree=OFF
```
- adding the following two libraries in the list under `cs_export`:
```
opencv_line_descriptor
opencv_ximgproc
```

(For a safer operation, just make sure that opencv3_catkin points to commit [bd876bc](https://github.com/ethz-asl/opencv3_catkin/commit/bd876bcf5ad393190e6c771be3f19e9e0df6470d)).

Build them (it could take 1 hour for the first time):
```
$ cd ~/catkin_ws/
$ catkin config --isolate-devel
$ caktin config -DCMAKE_BUILD_TYPE=Release
$ catkin build
```

## Usage of ROS packages
There are two launch files within the  `line_ros_utility` package:
* **detect\_cluster\_show.launch**: Works when run with a rosbag generated by  [scenenet\_ros\_tools](https://github.com/ethz-asl/scenenet_ros_tools).
* **freiburg.launch**: Works when run with a rosbag from the freiburg data set.

To store the detected lines as txt files, you need to set `write_labeled_lines` to true and change the
`kWritePath` parameter in `line_ros_utility.cc` to the path where you want to store these files.

These generated files are the data we will further manipulate in `python`. If you want to train a random forest on these detected lines' data. You can run `random_forest.py` as another ROS node. By setting `clustering_with_random_forest` in `line_ros_utility.cc` to true you can do online clustering with random forest trained on the data.
